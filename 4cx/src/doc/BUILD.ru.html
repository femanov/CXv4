<HTML>
<HEAD>
<TITLE>Система сборки CXv4</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="style.css">
</HEAD>
<BODY>

<H1>Система сборки CXv4</H1>

<B>ЗАМЕЧАНИЕ:</B> в этом документе в настоящий момент НЕ описывается
процесс создания своих Makefile'ов для системы сборки CXv4.

<P>В случае необходимости рекомендуется делать по образу и подобию примерно
аналогичных из <TT>hw4cx/</TT> и <TT>sw4cx/</TT>.


	<H2>Введение</H2>

<P>Система сборки построена на основе GNU Make, БЕЗ использования
дополнительных средств вроде automake/autoconf.  Требования к окружению:

  <UL TYPE=square>

  <LI>GNU Make версии 3.79 или выше.

  <LI>GCC версии 2.95 или выше.

  <LI>BASH или ZSH в качестве <TT>/bin/sh</TT>; Debian'овский DASH не
поддерживается (но см. раздел <A HREF="#debilian-uebuntu"><I>"При сборке под
Debian или Ubuntu выдаётся ошибка"</I></A> в конце).

  <LI>Для GUI-части требуется Motif и Xt (в современных системах по
умолчанию отсутствуют).

  <LI>Для кросс-компиляции под микроконтроллеры требуется поддержка
x86-32bit (в 64-битных системах по умолчанию отсутствует).

  </UL>

<P>Структура Makefile'ов многоуровневая, расположенные ниже по списку
<CODE>include</CODE>'ат предшествующие:

  <UL TYPE=square>

  <LI>Основные определения делаются в <TT>GeneralRules.mk</TT>, строго
говоря, могущем использоваться независимо от CX.

  <LI>Специфичные для CXv4 определения делаются в <TT>TopRules.mk</TT>.

  <LI>Опциональные специфичные для конкретной директории (точнее, однотипных
ГРУПП директорий) определения могут располагаться в <TT>DirRules.mk</TT>.

  <LI>При использовании вне основного дерева CXv4 специфичные для
конкретного проекта определения делаются в <TT>PrjRules.mk</TT>.

  <LI>При кросс-компиляции с использованием "теневых" директорий специфичные
для неё определения располагаются в <TT>ShadowRules.mk</TT>.

  <LI>Собственно <TT>Makefile</TT> конкретной директории.

  </UL>

<P>Организация <TT>GeneralRules.mk</TT> предоставляет возможность настройки
с каждого из вышеупомянутых уровней.

<P>Такая структура позволила вынести многократно используемые определения в
общие файлы, оставляя в конкретных <TT>Makefile</TT> в основном списки
файлов и описания зависимостей.

<P>В частности, функционал <TT>GeneralRules.mk</TT> включает:

  <UL TYPE=square>

  <LI>Правила компиляции для используемых в CXv4 типов файлов -- объектных
(<TT>*.o</TT>), исполняемых, динамических библиотек (<TT>*.so</TT>) и
статических библиотек-"архивов" (<TT>*.a</TT>).

  <LI>Правила для сборки, очистки и инсталляции.

  <LI>Автоматическую адаптацию под разные платформы.

  <LI>Автоматическую генерацию зависимостей для C-файлов.

  </UL>


	<H2>Стандартные цели</H2>

<P><TT>GeneralRules.mk</TT> поддерживает следующие цели (targets), которые
можно указывать в командной строке <CODE>make</CODE> (по умолчанию все
действия (кроме <CODE>files</CODE>) распространяются и на поддиректории):

  <OL>

  <LI>Цели для сборки:

    <DL>

    <DT><CODE>all</CODE></DT><DD>Цель по умолчанию -- cборка всех файлов, в
т.ч. в поддиректориях.  Является суммой <CODE>files</CODE> и
<CODE>subdirs</CODE>.</DD>

    <DT><CODE>files</CODE></DT><DD>Сборка всех файлов, БЕЗ поддиректорий.</DD>

    <DT><CODE>subdirs</CODE></DT><DD>Сборка в поддиректориях, БЕЗ файлов в
самой директории.</DD>

    <DT><CODE>install</CODE></DT><DD>Инсталляция.  Поведение внутри
<TT>4cx/src/</TT> и вне <TT>4cx/src/</TT> различается.

      <UL TYPE=square>

      <LI>Внутри <TT>4cx/src/</TT> сначала выполняется цель
<CODE>exports</CODE> (см. ниже), а затем готовое дерево из
<TT>4cx/exports/</TT> копируется в место назначения.

<P>Имеет смысл только непосредственно в <TT>4cx/src/</TT>.

      <LI>В прочих местах сразу выполняется копирование в места назначения.

<P>(Т.н. <I>"сборка вне основного дерева 4cx/"</I> или, кратко,
<I>"внедеревная сборка"</I>).

      </UL>

</DD>

    </DL>

  <LI>Цели для очистки:

    <DL>

    <DT><CODE>clean</CODE></DT><DD>Удаление файлов, появляющихся в
результате сборки: исполняемых файлов, а также т.н. "промежуточных" файлов
-- <TT>*.o</TT> и <TT>*.dep</TT>.</DD>

    <DT><CODE>distclean</CODE></DT><DD>В дополнение к удаляемым по
<CODE>clean</CODE>, удаляются также backup-файлы <TT>*~</TT>.</DD>

    <DT><CODE>maintainer-clean</CODE></DT><DD>В дополнение к удаляемым по
<CODE>distclean</CODE>, также удаляются файлы зависимостей <TT>*.d</TT> и
<TT>*.mkr</TT>.</DD>

<!--

    <DT><CODE>crit-clean</CODE></DT><DD>В дополнение к удаляемым по
<CODE>maintainer-clean</CODE>, удаляются также некоторые файлы, которые не
всегда могут быть воссозданы в процессе сборки.

<P>Использование этой цели крайне не рекомендуется, т.к. восстановление
после неё может быть затруднительно.

</DD>

-->

    </DL>

  <LI>Дополнительные цели, имеющие смысл только внутри самой <TT>4cx/src/</TT>.

    <DL>

    <DT><CODE>create-exports</CODE></DT><DD>Создание иерархии
<TT>4cx/exports/</TT>, пустой (предыдущее содержимое при этом удаляется).

<P>Имеет смысл только непосредственно в <TT>4cx/src/</TT>.

<P>"<CODE>make exports</CODE>" должно делаться непосредственно после
разворачивания <TT>4cx/src/</TT>.

</DD>

    <DT><CODE>exports</CODE></DT><DD>"Экспортирование" файлов в дерево
<TT>4cx/exports/</TT>.</DD>

<P>Требует ранее выполнявшегося "<CODE>make exports</CODE>".

    </DL>

  </OL>


	<H2>Управление процессом сборки</H2>

<P>Предусмотрена возможность настройки из командной строки Make уровня
оптимизации и поддержки отлаживаемости и профилируемости собираемых
программ.  Для этого служат следующие параметры, могущие указываться в
командной строке (через пробел):

  <DL>

  <DT><CODE>OPTIMIZATION</CODE></DT><DD>По умолчанию <CODE>=-O2</CODE>.

<P>Для удобства отладки следует отключать оптимизацию указанием
<CODE>OPTIMIZATION=-O0</CODE>.

</DD>

  <DT><CODE>DEBUGGABLE</CODE></DT><DD>По умолчанию <CODE>=YES</CODE>.

<P>Отключение -- <CODE>DEBUGGABLE=NO</CODE>.

<P>Отлаживаемость отключается, например, при кросс-компиляции под
микроконтроллеры, поскольку возможности отладки под них весьма ограничены и
в некоторых случаях компиляция с включенной отладкой просто невозможна.

</DD>

  <DT><CODE>PROFILABLE</CODE></DT><DD>По умолчанию <CODE>=NO</CODE>.

<P>Включение -- <CODE>PROFILABLE=YES</CODE>.

<P>Профилируемость требуется нечасто, а объём получаемых при сборке файлов
значительно увеличиватся.  Кроме того, профилируемость под микроконтроллеры
зачастую невозможна в принципе.

</DD>

  <DT><CODE>PREFIX</CODE></DT><DD>По умолчанию <CODE>=/tmp/4cx</CODE>.

<P>Определяет корневую точку, в которую инсталлируется дерево по "<CODE>make
install</CODE>".

<P>Для инсталляции в стандартную <TT>~/4pult</TT> --
<CODE>PREFIX=${HOME}/4pult</CODE>.

</DD>

  </DL>


	<H2>Некоторые особенности функционирования</H2>

		<H3>Автоматическая настройка под хост-платформу</H3>

<P>Поддерживается сборка не только под Linux (причём разных версий, с
разными версиями gcc и под разные архитектуры), но также и под OpenBSD, и
при необходимости может быть добавлена поддержка большинства Unix-подобных
платформ (исторически поддерживались также FreeBSD, Solaris, SunOS,
Unixware, IRIX и OSF/1, но с их исчезновением из обихода эта потребность
отпала).

<P>Поскольку никакая "предварительная конфигурация" (automake, autoconf,
...) не используется, то система сборки определяет тип платформы
самостоятельно и выполняет соответствующую "тонкую настройку" в момент
сборки.

  <UL TYPE=square>

  <LI>На уровне Make это заключается в вызове (из <TT>Config.mk</TT>)
скрипта <TT>scripts/Sysdepflags.sh</TT> и установке на основе полученной
информации make-переменных <CODE>OS</CODE> и <CODE>CPU</CODE>.

  <LI>Затем значения этих переменных передаются компилятору GCC, при помощи
ключей <CODE>-DOS=...</CODE> и <CODE>-DCPU=...</CODE>.

  <LI>Части C-кода, чувствительные к различиям в разных ОС/платформах,
делают <CODE>#include</CODE> файла <TT>cx_sysdeps.h</TT>, в котором на
основании значений <CODE>OS</CODE> и <CODE>CPU</CODE> делаются специфические
настройки.

  <LI>Кроме того, в интересах кросс-сред устанавливается make-переменная
<CODE>CPU_X86_COMPAT</CODE>, указывающая, что процессор хост-системы -- x86
либо x86_64.

  <LI>Также сам <TT>GeneralRules.mk</TT> сам проверяет версию GCC, поскольку
поведение компилятора и препроцессора в некоторых критичных аспектах
менялось (начиная с 2.96 изменилось управление генерацией зависимостей, а с
4.0 появилась поддержка флага <CODE>-Wno-missing-field-initializers</CODE>,
сильно сокращающего объем бесполезной диагностики).

  </UL>


		<H3>Автоматическая генерация зависимостей</H3>

<P>GCC позволяет решить врождённую проблему языка C -- отсутствие
установления зависимостей между файлами (когда некий <TT>ФАЙЛ.c</TT>
<CODE>#incude</CODE>'ит какой-нибудь <TT>ФАЙЛ_ОПРЕДЕЛЕНИЙ.h</TT>, то
результат компиляции <TT>ФАЙЛ.o</TT> зависит от <TT>ФАЙЛ_ОПРЕДЕЛЕНИЙ.h</TT>,
и аналогично с вложенными <CODE>#incude</CODE>).  В GCC предусмотрен ключ
<CODE>-MM</CODE>, выдающий список зависимостей в подходящем для Make
формате.

<P>Однако исторически для использования этой возможности нужно было писать в
Makefile'ах дополнительные правила, а генерацию зависимостей требовалось
вызывать вручную, командой "<CODE>make depend</CODE>".  Это крайне неудобно
и при модификации исходников приводило к рассогласованию информации в файлах
"<TT>depend</TT>" с реальным состоянием дел.

<P>GNU Make позволяет решить и эту проблему, при помощи поддержки
ре-генерации Makefile'ов с автоматическим повторным считыванием.  Подробнее
см. раздел

"<A HREF="https://www.gnu.org/software/make/manual/html_node/Automatic-Prerequisites.html">Generating
Prerequisites Automatically</A>" в документации GNU Make.

<P><TT>GeneralRules.mk</TT> использует эту возможность, реализуя её в чуть
улучшенном виде (по сравнению с описанным в документации способом). 
Зависимости записываются в файлы <TT>*.d</TT>, а генерация идёт через
промежуточные файлы <TT>*.dep</TT> (вместо предлагаемой в документации
длинной цепочки команд с временными файлами).

<P>Автоматическая генерация зависимостей выполняется для всех исходных
файлов в <TT>4cx/</TT>, а также для всех файлов во внешних директориях
(<TT>hw4cx/</TT>, <TT>sw4cx/</TT> и проч.), использующих принятые в системе
сборки способы указания списков целей и файлов (make-переменными
<CODE>EXES</CODE>, <CODE>SOLIBS</CODE>, <CODE>ARLIBS</CODE>,
<CODE>MONO_C_FILES</CODE> и подобными, а также <CODE>*_COMPONENTS</CODE>).


	<H2>Некоторые часто встречающиеся проблемы и пути их решения</H2>

		<H3 ID="debilian-uebuntu">При сборке под Debian или Ubuntu выдаётся ошибка</H3>

  <DL>

  <DT>Причина:</DT><DD>

<P>Юмористы из Debian решили начхать на стандарты и в качестве системного
shellscript-processor'а <TT>/bin/sh</TT> в Debi[li]an и ОС на его основе
используется <CODE>dash</CODE>, несовместимый с де-факто стандартом
<CODE>bash</CODE>.

<P>Проявляющаяся при сборке CXv4 ошибка компиляции является как раз
следствием одной из таких несовместимостей: встроенная в <CODE>dash</CODE>
реализация команды <CODE>echo</CODE> не понимает ключ <CODE>-e</CODE> и
просто передаёт его в выходной поток, в результате чего в генеримом файле
оказывается строка вроде

<BLOCKQUOTE CLASS=excerpt><CODE>-e #include "v2cxlib_renames.h"</CODE></BLOCKQUOTE>

</DD>

  <DT>Решение:</DT><DD>

<P>Есть 2 варианта -- общесистемный и на локальный на время сборки.

    <OL>

    <LI>Общесистемный: заменить стандартный интерпретатор
<TT>/bin/sh</TT> со скудоумного <CODE>dash</CODE> на полноценный
<CODE>bash</CODE>.  Для этого надо выполнить с правами root команду

<BLOCKQUOTE CLASS=excerpt><CODE>ln -sf bash /bin/sh</CODE></BLOCKQUOTE>

    <LI>На время компиляции: в командной строке make добавить (через пробел)
параметр <CODE>SHELL=/bin/bash</CODE>.

    </OL>

</DD>

  </DL>

		<H3>При сборке выдаётся ошибка в директории <TT>lib/AuxMotifWidgets</TT></H3>

  <DL>

  <DT>Причина:</DT><DD>Скорее всего, в системе отсутствуют библиотеки и/или
include-файлы для Motif и Xt (в новых дистрибутивах они по умолчанию не
устанавливаются).

</DD>

  <DT>Решение:</DT><DD>

    <UL TYPE=square>

    <LI>Если сборка GUI-части CX не требуется, то её можно отключить, указав
в командной строке make (через пробел) параметр <CODE>NOX=1</CODE>.

<P>Это касается как <TT>4cx/</TT>, так и <TT>hw4cx/</TT> с
<TT>sw4cx/</TT>.

    <LI>Если GUI-часть всё же нужна, то требуется инсталлировать Xt и Motif
(как runtime, так и devel).  В RedHat-совместимых дистрибутивах эти пакеты
обычно называются libXt, libXt-devel, openmotif, openmotif-devel.

    </UL>

</DD>

  </DL>


		<H3>При сборке <TT>hw4cx/</TT> под 64-битной системой выдаётся ошибка в <TT>x-build/</TT></H3>

  <DL>

  <DT>Причина:</DT><DD>Кросс-среды, используемые для сборки под ARM и
PowerPC, являются 32-битными.  По умолчанию в 64-битные системы 32-битные
библиотеки совместимости не устанавливаются, поэтому 32-битные компиляторы
кросс-сред не могут запуститься.

</DD>

  <DT>Решение:</DT><DD>

    <UL TYPE=square>

    <LI>Если сборка под микроконтроллеры не требуется, то её можно
отключить, указав в командной строке make (через пробел) параметр
<CODE>CPU_X86_COMPAT=NO</CODE>.

    <LI>Если всё же требуется сборка драйверов под микроконтроллеры, то
следует поставить необходимые 32-битные библиотеки (обсуждение их списка
выходит за рамки этого документа).

    </UL>

</DD>

  </DL>


</BODY>
</HTML>
