<HTML>
<HEAD>
<TITLE>Каналы _devstate -- что это такое</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="style.css">
</HEAD>
<BODY>

<H1>Каналы <TT>_devstate</TT> -- что это такое</H1>

	<H2>Мониторирование состояния устройства</H2>

<P>CX-сервер для каждого устройства автоматически создаёт 2 канала:

  <UL TYPE=square>

  <LI><TT>_devstate</TT> -- целочисленный канал, содержащий текущее
состояние устройства.  Значения совпадают с константами
<CODE>DEVSTATE_nnn</CODE> (файл <TT>cxsd_driver.h</TT>):

    <UL TYPE=square>

    <LI><CODE>-1</CODE> -- <CODE>DEVSTATE_OFFLINE</CODE>, устройство не
работает и работать не будет (например, устройство на шине отсутствует).

    <LI><CODE>&nbsp;0</CODE> -- <CODE>DEVSTATE_NOTREADY</CODE>, устройство
не готово (например, не включено питание).

    <LI><CODE>+1</CODE> -- <CODE>DEVSTATE_OPERATING</CODE>, устройство
работает нормально.

    </UL>

  <LI><TT>_devstate_description</TT> -- строковый канал, содержащий описание
проблемы с устройством, если оно указано драйвером.  При неуказанности или в
состоянии OPERATING тут будет пустая строка.

  </UL>

<P>Оба канала обновляются в момент смены состояния устройства. 
Соответственно, метка времени (timestamp) канала <TT>_devstate</TT> отражает
время последней смены состояния этого устройства.

<P>Основное назначение канала <TT>_devstate</TT> -- удалённое
мониторирование состояния устройства, причём через обычный интерфейс
каналов.  Эта возможность используется, в частности, в

<A HREF="lib/vdev.ru.html">библиотеке vdev</A>.


	<H2>Управление состоянием устройства</H2>

<P>Начиная с версии декабря 2018г канал <TT>_devstate</TT> может также
использоваться для УПРАВЛЕНИЯ устройством.  Это делается путём записи в
данный канал одного из 3 значений:

    <UL TYPE=square>

    <LI><CODE>-1</CODE> -- принудительно отключить устройство.

<P>Вызывается метод <CODE>term_dev()</CODE> драйвера и затем устройство
помечается как отключенное (OFFLINE, -1).

    <LI><CODE>&nbsp;0</CODE> -- рестартовать устройство: сначала перевести в
состояние отключения, а затем выполнить попытку включить.

<P>Технически запись <CODE>_devstate=0</CODE> эквивалентна последовательной
записи сначала <CODE>_devstate=-1</CODE>, а затем <CODE>_devstate=+1</CODE>.

    <LI><CODE>+1</CODE> -- выполнить попытку включить устройство: если оно
находится в состоянии отключенности (OFFLINE, -1), то вызывается
инициализация.

<P>Если устройство находится в состояниях "не готово" (NOTREADY, 0) или
"работает нормально" (OPERATING, +1), то ничего не делается.

    </UL>

<P><B>Замечания:</B>

  <OL>

  <LI>Значения <CODE>-1</CODE> и <CODE>+1</CODE> совпадают cо значениями
состояний, читаемых из канала <TT>_devstate</TT>, а значение <CODE>0</CODE>
имеет иной смысл.

  <LI>Операция "попытка включить устройство" означает именно ПОПЫТКУ:
вызывается операция инициализации (метод <CODE>init_dev()</CODE> драйвера),
точно так же, как при старте сервера, и затем уже драйвер устройства по
своим алгоритмам пытается установить связь с устройством и взять на себя
управление им.

  </OL>

</BODY>
</HTML>
